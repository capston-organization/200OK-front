<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ë§›ìˆëŠ” ê³¼ì¼ì´ ë¨¹ê³  ì‹¶ì–´!</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style>
      /* ğŸ’¡ [ìˆ˜ì •] í°íŠ¸ ê²½ë¡œë¥¼ ë¡œì»¬ íŒŒì¼ë¡œ ì§€ì • */
      @font-face {
        font-family: "Jua";
        src: url("../../assets/Fonts/Jua.ttf") format("truetype");
      }

      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        background: #000;
        font-family: "Jua", sans-serif; /* ê¸°ë³¸ í°íŠ¸ ì ìš© */
        overflow: hidden; /* ğŸ’¡ ìŠ¤í¬ë¡¤ë°” ê°•ì œ ì œê±° */
        background-color: #000000; /* ë¹ˆ ê³µê°„ ê²€ì€ìƒ‰ ì²˜ë¦¬ */
      }

      canvas {
        display: block; /* ìº”ë²„ìŠ¤ í•˜ë‹¨ ê³µë°± ì œê±° */
      }
    </style>
  </head>
  <body>
    <script>
      const SCALE = {
        // ìŠ¤í”„ë¼ì´íŠ¸ í¬ê¸° ì¡°ì ˆí•˜ëŠ” ê³³
        POCKET: 1.0,
        MALONG: 1.0,
        BOWL: 1.0,
        TABLE: 1.0,
        TIMER: 1.0,
      };

      class GameScene extends Phaser.Scene {
        constructor() {
          // ì‚¬ìš©í•  ë³€ìˆ˜ë“¤ì„ ì €ì¥í•©ë‹ˆë‹¤.
          super("GameScene");
          this.score = 0;
          this.gameTime = 40; // ê²Œì„ ì†Œìš” ì‹œê°„
          this.gameTimer = 40; // íƒ€ì´ë¨¸ì— ì‚¬ìš©í•  ì‹œê°„
          this.isGameStarted = false; // ready? ì™€ ê²Œì„ì„ êµ¬ë³„í•˜ê¸° ìœ„í•œ í”Œë˜ê·¸
          this.isGameOver = false; // ê²Œì„ê³¼ finish!ë¥¼ êµ¬ë³„í•˜ê¸° ìœ„í•œ í”Œë˜ê·¸
          this.pockets = []; // ì»´í¬ë„ŒíŠ¸ë¥¼ ê´€ë¦¬í•  ë•Œ ì‚¬ìš©í•˜ëŠ” ë¦¬ìŠ¤íŠ¸
          this.currentAnswer = 0; // í˜„ì¬ ë‹µì¸ ì£¼ë¨¸ë‹ˆì˜ ë²ˆí˜¸
          this.consecutiveCorrect = 0; // ì—°ì†ìœ¼ë¡œ ëª‡ ë¬¸ì œë¥¼ ë§ì·„ëŠ”ì§€ì— ëŒ€í•œ í”Œë˜ê·¸
          this.isProcessingTurn = false; // ğŸ’¡ ì¤‘ë³µ í´ë¦­ ë°©ì§€ í”Œë˜ê·¸
          this.fruitStep = 0; // ğŸ’¡ ê³¼ì¼ ë‹¨ê³„ ë³€ìˆ˜
        }

        preload() {
          // ì´ë¯¸ì§€ë¥¼ ë¡œë”©í•˜ëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤.
          this.load.setPath("../../assets/game1/Sprites/");

          this.load.image("background", "Background.png");
          this.load.image("quiz_board", "QuizBoard.png");
          this.load.image("quiz_icon", "QuizIcon.png");
          this.load.image("timer_graphic", "timerGraphic.png");
          this.load.image("table", "table.png");

          this.load.image("malong_default", "malong_default.png");
          this.load.image("malong_sad", "malong_sad.png");
          this.load.image("malong_happy", "malong_happy.png");

          this.load.image("defaultPack_lock", "defaultPack_lock.png");
          this.load.image("defaultPack_open", "defaultPack_open.png");
          this.load.image("goodPack_lock", "goodPack_lock.png");
          this.load.image("goodPack_open", "goodPack_open.png");

          this.load.image("bowl0", "bowl0.png");
          for (let i = 1; i <= 15; i++) {
            this.load.image(`bowl${i}`, `bowl${i}.png`);
            this.load.image(`fruit${i}`, `fruit${i}.png`);
          }
        }

        create() {
          // ê²Œì„ì„ 1920x1080 í¬ê¸°ë¡œ ìƒì„±í•©ë‹ˆë‹¤. ê²Œì„ ìŠ¤í”„ë¼ì´íŠ¸ë“¤ì˜ ìœ„ì¹˜ì™€ í¬ê¸°ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
          const gameWidth = 1920;
          const gameHeight = 1080;
          const centerX = gameWidth / 2;

          // 1. ë°°ê²½
          this.add
            .image(centerX, gameHeight / 2, "background")
            .setDisplaySize(gameWidth, gameHeight)
            .setDepth(0);

          // [1] ìƒë‹¨ ë¬¸ì œíŒ
          const boardY = 130;
          this.quizBoard = this.add
            .image(centerX, boardY, "quiz_board")
            .setOrigin(0.5)
            .setDepth(10);
          this.quizIcon = this.add
            .image(centerX - 800, boardY, "quiz_icon")
            .setOrigin(0.5)
            .setDepth(11);
          this.questionProblem = this.add
            .text(centerX + 50, boardY, "", {
              fontSize: "72px",
              fill: "#FFFFFF",
              fontFamily: "Jua",
              fontStyle: "bold",
              fontFamily: "Arial",
              stroke: "#000000",
              strokeThickness: 6,
            })
            .setOrigin(0.5)
            .setDepth(12);

          // [2] í…Œì´ë¸”
          const tableY = 980;
          this.table = this.add
            .image(centerX, tableY, "table")
            .setOrigin(0.5, 1)
            .setScale(SCALE.TABLE)
            .setDepth(10);
          const tableSurfaceY = tableY - this.table.displayHeight * 0.85;

          // [3] ë§ë¡±ì´ & ê·¸ë¦‡
          this.malong = this.add
            .image(centerX - 200, tableSurfaceY + 70, "malong_default")
            .setOrigin(0.5, 1)
            .setScale(SCALE.MALONG)
            .setDepth(5);
          this.bowl = this.add
            .image(centerX + 100, tableSurfaceY, "bowl0")
            .setOrigin(0.5, 1)
            .setScale(SCALE.BOWL)
            .setDepth(11);

          // [4] íƒ€ì´ë¨¸
          const timerY = 960;
          this.timerBgGraphic = this.add
            .image(centerX, timerY, "timer_graphic")
            .setOrigin(0.5)
            .setScale(SCALE.TIMER)
            .setDepth(30);

          const bgWidth = this.timerBgGraphic.displayWidth;
          const bgHeight = this.timerBgGraphic.displayHeight;
          this.timerBarWidth = bgWidth * 0.95;
          this.timerBarHeight = bgHeight * 0.35;

          this.timerBar = this.add
            .rectangle(
              centerX - this.timerBarWidth / 2,
              timerY + 40,
              this.timerBarWidth,
              this.timerBarHeight,
              0x00ff00
            )
            .setOrigin(0, 0.5)
            .setDepth(31);

          // [5] READY í™”ë©´
          this.readyOverlay = this.add
            .rectangle(
              centerX,
              gameHeight / 2,
              gameWidth,
              gameHeight,
              0x000000,
              0.6
            )
            .setDepth(100);
          this.readyText = this.add
            .text(centerX, gameHeight / 2, "READY?", {
              fontSize: "140px",
              fill: "#FFFFFF",
              fontFamily: "Jua",
              fontStyle: "bold",
              stroke: "#000000",
              strokeThickness: 10,
            })
            .setOrigin(0.5)
            .setDepth(101);

          this.time.delayedCall(3000, this.startGame, [], this);
          this.spawnPocketsWithQuestion(false);
          // Start í‘œê¸°ê°€ ì ê¹ ëœ¨ê³  ë¬¸ì œê°€ ì‹œì‘ë©ë‹ˆë‹¤.
        }

        startGame() {
          // ê²Œì„ì„ ì‹œì‘í•˜ëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤.
          this.isGameStarted = true;
          this.readyOverlay.destroy();
          this.readyText.destroy();
          // ready ê¸€ì”¨ê°€ ë„ì›Œì§€ëŠ” ì°½ì„ ì§€ì›ë‹ˆë‹¤.

          this.pockets.forEach((p) => {
            p.setVisible(true);
            if (p.label) p.label.setVisible(true);
          });
          this.setupTimers();
          // ëª¨ë“  ì»´í¬ë„ŒíŠ¸ë“¤ì„ ë³´ì´ê²Œ í•˜ê³ , íƒ€ì´ë¨¸ë¥¼ ì„¸íŒ…í•©ë‹ˆë‹¤.
        }

        setupTimers() {
          this.time.addEvent({
            delay: 1000, // 1ì´ˆë§ˆë‹¤ í•œë²ˆì”© ì´ í•¨ìˆ˜ê°€ ìˆ˜í–‰ë©ë‹ˆë‹¤.
            callback: () => {
              // íƒ€ì´ë¨¸ì˜ ìœ„ì¹˜ì™€ í¬ê¸°ë¥¼ ì§€ì •í•˜ëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤.
              if (!this.isGameStarted || this.isGameOver) return; // ë§Œì•½ ê²Œì„ ì¤‘ì´ ì•„ë‹ˆë¼ë©´ íƒ€ì´ë¨¸ê°€ ê°ì†Œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
              this.gameTimer--;
              this.timerBar.scaleX = this.gameTimer / this.gameTime; // íƒ€ì´ë¨¸ ê·¸ë˜í”½ì„ ì¡°ì •í•©ë‹ˆë‹¤.
              if (this.timerBar.scaleX <= 0.3)
                this.timerBar.setFillStyle(0xff0000);
            },
            loop: true,
          });
          this.time.delayedCall(this.gameTime * 1000, this.endGame, [], this); // gameTimeì´ˆë§Œí¼ ì§€ë‚˜ë©´, endGame í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
        }

        generateMathQuestion() {
          // ì¼ë‹¨ ê¸°ë³¸ì ìœ¼ë¡œ ì‚¬ì¹™ì—°ì‚° ë¬¸ì œë¥¼ ìƒì„±í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.
          const num1 = Phaser.Math.Between(1, 15);
          const num2 = Phaser.Math.Between(1, 15);
          const operators = ["+", "-", "*"];
          const operator = Phaser.Utils.Array.GetRandom(operators);
          let answer = 0;
          let qStr = "";
          switch (operator) {
            case "+":
              answer = num1 + num2;
              qStr = `${num1} + ${num2}`;
              break;
            case "-":
              answer = num1 - num2;
              qStr = `${num1} - ${num2}`;
              break;
            case "*":
              answer = num1 * num2;
              qStr = `${num1} * ${num2}`;
              break;
          }

          const options = [answer];
          let safeGuard = 0; // ğŸ’¡ [ìˆ˜ì •] ë¬´í•œ ë£¨í”„ ë°©ì§€ ì¹´ìš´íŠ¸

          while (options.length < 4) {
            safeGuard++;
            if (safeGuard > 100) {
              // 100ë²ˆ ì‹œë„í•´ë„ ëª» ì°¾ìœ¼ë©´ ê·¸ëƒ¥ ì•„ë¬´ ìˆ«ìë‚˜ ë„£ì–´ì„œ ë©ˆì¶¤ ë°©ì§€
              options.push(answer + options.length + 1);
              continue;
            }

            let d = answer + Phaser.Math.Between(-10, 10);
            if (d >= 0 && d !== answer && !options.includes(d)) {
              options.push(d);
            }
          }

          Phaser.Utils.Array.Shuffle(options);
          return { question: qStr, answer: answer, options: options };
        }

        spawnPocketsWithQuestion(showPockets = true) {
          // ì£¼ë¨¸ë‹ˆë¥¼ ìƒì„±í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.
          if (this.isGameOver) return; // ë§Œì•½ ê²Œì„ì´ ëë‚¬ë‹¤ë©´ ì£¼ë¨¸ë‹ˆë¥¼ ìƒì„±í•´ì„  ì•ˆë©ë‹ˆë‹¤.

          // ğŸ’¡ [ì•ˆì „ì¥ì¹˜ 1] í”Œë˜ê·¸ í•´ì œ (ìƒˆ ë¼ìš´ë“œ ì‹œì‘)
          this.isProcessingTurn = false; // ìƒˆ ì£¼ë¨¸ë‹ˆê°€ ìƒì„±ë˜ë©´, í´ë¦­í•  ìˆ˜ ìˆê²Œ ì´ ê°’ì„ falseë¡œ ë°”ê¿”ì¤€ë‹¤.

          // ğŸ’¡ [ì•ˆì „ì¥ì¹˜ 2] ì•ˆì „í•˜ê²Œ ê°ì²´ ì‚­ì œ (Try-Catch & ì• ë‹ˆë©”ì´ì…˜ ì œê±°)
          try {
            // ì£¼ë¨¸ë‹ˆë¥¼ ì‚­ì œí•˜ëŠ” ë¡œì§ì´ì§€ë§Œ, ë§Œì•½ ì£¼ë¨¸ë‹ˆê°€ ì´ë¯¸ ì‚­ì œë˜ì—ˆë‹¤ë©´ ê·¸ëƒ¥ catch ë¬¸ìœ¼ë¡œ ë„˜ì–´ê°€ê¸° ìœ„í•´ try-catchë¥¼ ì‚¬ìš©í•œë‹¤.
            this.pockets.forEach((p) => {
              if (p) {
                this.tweens.killTweensOf(p); // ì£¼ë¨¸ë‹ˆì— ì—°ê²°ëœ ì• ë‹ˆë©”ì´ì…˜ ê°•ì œ ì¢…ë£Œ
                if (p.label) p.label.destroy(); // ì• ë‹ˆë©”ì´ì…˜ ê°•ì œ ì¢…ë£Œ ì „ destroyë¥¼ í•´ë²„ë¦¬ë©´, ì• ë‹ˆë©”ì´ì…˜ì„ ìˆ˜í–‰í•´ì•¼í•˜ëŠ” ê°ì²´ë¥¼ ëª» ì°¾ì•„ ì—ëŸ¬ê°€ ë‚œë‹¤.
                p.destroy();
              }
            });
            this.pockets = [];

            const qData = this.generateMathQuestion();
            // í•¨ìˆ˜ë¡œ ë¬¸ì œë¥¼ ë§Œë“¤ì–´ì„œ qDataì— ë„£ìŠµë‹ˆë‹¤.

            this.questionProblem.setText(`${qData.question} = ?`);
            this.currentAnswer = qData.answer;
            // ë¬¸ì œ ë¶€ë¶„ê³¼ í˜„ì¬ ë‹µ ë¶€ë¶„ì„ ì •í•©ë‹ˆë‹¤.

            let isSpecial = this.consecutiveCorrect >= 5; // ë§Œì•½ ìœ ì €ê°€ 5ê°œ ì—°ì†ìœ¼ë¡œ ë§ì¶˜ ê²½ìš°
            if (isSpecial) this.consecutiveCorrect = 0; // ì—°ì† ë¬¸ì œ ë§ì¶˜ ê°œìˆ˜ë¥¼ ë¦¬ì…‹í•©ë‹ˆë‹¤.

            const pocketY = 450;
            for (let i = 0; i < 4; i++) {
              const xPos = (this.cameras.main.width / 5) * (i + 1);
              let pKey = isSpecial ? "goodPack_lock" : "defaultPack_lock"; // íŠ¹ë³„ ì£¼ë¨¸ë‹ˆì¸ì§€ ì•„ë‹Œì§€ êµ¬ë¶„í•˜ëŠ” ë¡œì§
              const pocket = this.add
                .sprite(xPos, pocketY, pKey)
                .setOrigin(0.5)
                .setInteractive({ useHandCursor: true })
                .setVisible(showPockets)
                .setScale(SCALE.POCKET)
                .setDepth(15);

              pocket.label = this.add
                .text(xPos, pocketY + 40, qData.options[i], {
                  fontSize: "52px",
                  fill: "#000000",
                  fontFamily: "Jua",
                  fontStyle: "bold",
                })
                .setOrigin(0.5)
                .setVisible(showPockets)
                .setDepth(16);

              pocket.setData("value", qData.options[i]);
              pocket.setData("isSpecial", isSpecial);
              pocket.on("pointerdown", () => {
                // í•´ë‹¹ ì£¼ë¨¸ë‹ˆë¥¼ í´ë¦­í–ˆì„ ë•Œ, onPocketClickedê°€ í˜¸ì¶œëœë‹¤.
                this.onPocketClicked(pocket); // ì¸ìˆ˜ë¡œ pocket(ë²ˆí˜¸, íŠ¹ë³„ ì£¼ë¨¸ë‹ˆ ì—¬ë¶€) ê°ì²´ë¥¼ ë³´ë‚¸ë‹¤.
              });
              this.pockets.push(pocket); // í•´ë‹¹ ê°ì²´ë¥¼ ì»´í¬ë„ŒíŠ¸ë¥¼ ê´€ë¦¬í•˜ëŠ” pockets ë¦¬ìŠ¤íŠ¸ì— ë„£ì–´ë‘”ë‹¤.
            }
            // ì£¼ë¨¸ë‹ˆ ìœ„ì— í…ìŠ¤íŠ¸ê°€ ì˜¬ë¼ê°€ìˆë„ë¡ í•˜ê³ , ë§ëŠ” ì£¼ë¨¸ë‹ˆë¥¼ ì¶œë ¥í•˜ëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤.
          } catch (error) {
            console.error("ë‹¤ìŒ ë¬¸ì œ ìƒì„± ì¤‘ ì—ëŸ¬ ë°œìƒ:", error);
            // ì—ëŸ¬ê°€ ë‚˜ë„ ê²Œì„ì´ ë©ˆì¶”ì§€ ì•Šê²Œ ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜ ë„˜ì–´ê°€ëŠ” ì²˜ë¦¬
          }
        }

        onPocketClicked(clickedPocket) {
          if (!this.isGameStarted || this.isGameOver || this.isProcessingTurn)
            return; // ë§Œì•½ ê²Œì„ ì¤‘ì´ ì•„ë‹ˆê±°ë‚˜, ì´ë¯¸ ì£¼ë¨¸ë‹ˆë¥¼ ì„ íƒí•´ì„œ ì ì‹œ ê¸°ë‹¤ë¦¬ëŠ” ìƒí™©ì¼ ë•Œë©´ ì§„í–‰í•˜ì§€ ì•ŠëŠ”ë‹¤.
          this.isProcessingTurn = true; // ì´ ê°’ì„ trueë¡œ í•¨ìœ¼ë¡œì„œ ë‹¤ë¥¸ ì£¼ë¨¸ë‹ˆë¥¼ í´ë¦­í•  ìˆ˜ ì—†ê²Œ í•œë‹¤.

          this.pockets.forEach((p) => {
            p.disableInteractive(); // í•´ë‹¹ ì£¼ë¨¸ë‹ˆë¥¼ ë”ì´ìƒ í´ë¦­í•  ìˆ˜ ì—†ê²Œ í•œë‹¤.
            if (p === clickedPocket) {
              p.setTexture(
                p.getData("isSpecial") ? "goodPack_open" : "defaultPack_open"
              ); // ì£¼ë¨¸ë‹ˆê°€ íŠ¹ë³„í•œ ì£¼ë¨¸ë‹ˆì¸ì§€ ì•„ë‹Œì§€ì— ë”°ë¼ ì¶œë ¥í•  í…ìŠ¤ì²˜ê°€ ë‹¤ë¥´ë‹¤.
              if (p.label) p.label.setVisible(false); // í´ë¦­í•œ ì£¼ë¨¸ë‹ˆì˜ ë¬¸ì œ ë‹µì€ ì‚¬ë¼ì§„ë‹¤.
              this.tweens.killTweensOf(p); // í´ë¦­í•œ ì£¼ë¨¸ë‹ˆì˜ ì• ë‹ˆë©”ì´ì…˜ì„ êº¼ë²„ë¦°ë‹¤.
              p.setScale(SCALE.POCKET);
            } else {
              // ë§Œì•½ ì„ íƒí•œ ì£¼ë¨¸ë‹ˆê°€ ì•„ë‹ˆë¼ë©´
              p.setAlpha(0.5); // íˆ¬ëª…ë„ë¥¼ 50%ë¡œ ì¡°ì ˆí•´, ì„ íƒí•˜ì§€ ì•Šì•˜ìŒì„ ì‹œê°ì ìœ¼ë¡œ í‘œí˜„í•©ë‹ˆë‹¤.
            }
          });

          const val = clickedPocket.getData("value");
          const isSpecial = clickedPocket.getData("isSpecial");

          if (val === this.currentAnswer)
            // ë§Œì•½ ì„ íƒí•œ ì£¼ë¨¸ë‹ˆê°€ ì œëŒ€ë¡œ ëœ ì£¼ë¨¸ë‹ˆì¸ ê²½ìš°
            this.handleCorrect(isSpecial, clickedPocket);
          // handleCorrect í•¨ìˆ˜ë¥¼ í˜¸ì¶œ
          else this.handleIncorrect(); // í‹€ë¦° ê²½ìš° handleInCorrect í•¨ìˆ˜ë¥¼ í˜¸ì¶œ

          // ëŒ€ê¸° ì‹œê°„ì„ 1000 -> 1400ìœ¼ë¡œ ëŠ˜ë ¸ìŠµë‹ˆë‹¤.
          // ê³¼ì¼ì´ 0.7ì´ˆ ëŒ€ê¸° + 0.6ì´ˆ ì´ë™ = 1.3ì´ˆê°€ ê±¸ë¦¬ë¯€ë¡œ,
          // ë„‰ë„‰í•˜ê²Œ 1.4ì´ˆ ë’¤ì— ë‹¤ìŒ ë¬¸ì œê°€ ë‚˜ì˜¤ê²Œ í•´ì•¼ í”„ë¦¬ì§•ì´ ì¼ì–´ë‚˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
          this.time.delayedCall(1400, () => {
            this.spawnPocketsWithQuestion(true);
          });
        }

        handleCorrect(isSpecial, pocket) {
          // ì£¼ë¨¸ë‹ˆë¥¼ ì˜ ë§ì¶˜ ê²½ìš°ì— í˜¸ì¶œë©ë‹ˆë‹¤.
          this.score += isSpecial ? 3 : 1; // íŠ¹ë³„í•œ ì£¼ë¨¸ë‹ˆë¼ë©´ 3ì , ì•„ë‹ˆë©´ 1ì ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
          this.fruitStep++; // ê³¼ì¼ ë‹¨ê³„ë¥¼ ë°”ê¿‰ë‹ˆë‹¤.
          this.consecutiveCorrect++; // ì—°ì†ìœ¼ë¡œ ë¬¸ì œë¥¼ ë§ì¶˜ ìˆ˜ë¥¼ ì¦ê°€ì‹œí‚µë‹ˆë‹¤.

          let fIdx = Math.min(this.fruitStep, 15);
          let fKey = `fruit${fIdx}`;

          if (this.textures.exists(fKey)) {
            // í˜„ì¬ ê³¼ì¼ ë‹¨ê³„ì— ë§ëŠ” í…ìŠ¤ì²˜ê°€ ì¡´ì¬í•˜ëŠ” ê²½ìš°
            const flyingFruit = this.add
              .sprite(pocket.x, pocket.y - 50, fKey)
              .setScale(0)
              .setDepth(30);

            // 1. ê³¼ì¼ ë¿…! (ë“±ì¥)
            this.tweens.add({
              targets: flyingFruit,
              scale: 1.0,
              duration: 200,
              ease: "Back.out",
            });

            // 2. 0.7ì´ˆ(700ms) ëŒ€ê¸° í›„ ê·¸ë¦‡ìœ¼ë¡œ ë‚ ì•„ê°€ê¸°
            this.time.delayedCall(700, () => {
              // ì•ˆì „ì¥ì¹˜: ê³¼ì¼ì´ ê·¸ì‚¬ì´ ì‚­ì œëìœ¼ë©´ ì‹¤í–‰í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
              if (!flyingFruit.active) return;

              this.tweens.add({
                targets: flyingFruit,
                x: this.bowl.x,
                y: this.bowl.y - 100,
                duration: 600,
                ease: "Back.in", // ì™ ë“¤ì–´ê°€ëŠ” ëŠë‚Œ
                onComplete: () => {
                  if (flyingFruit.active) flyingFruit.destroy(); // ê·¸ë¦‡ìœ¼ë¡œ ë‚ ì•„ê°„ ë’¤ ë°”ë¡œ ê³¼ì¼ì„ ì‚­ì œí•©ë‹ˆë‹¤.
                  this.updateBowlGraphic(); // ê·¸ë¦¬ê³  ê·¸ë¦‡ ê·¸ë˜í”½ì„ ê°±ì‹ í•©ë‹ˆë‹¤.
                },
              });
            });
          } else {
            this.updateBowlGraphic(); // í˜¹ì‹œ ê³¼ì¼ í…ìŠ¤ì²˜ê°€ ìœ ì‹¤ë˜ì—ˆì„ ë•Œë„, ê²Œì„ì´ ëŒì•„ê°€ê²Œ ë§Œë“œëŠ” ì½”ë“œ
          }

          this.updateMalongStatus("happy");
          // ë§ë¡±ì´ í‘œì •ë„ ê³¼ì¼ ë„ì°© ì‹œê°„ì— ë§ì¶°ì„œ ëŒì•„ì˜¤ê²Œ ìˆ˜ì • (1.4ì´ˆ ë’¤)
          this.time.delayedCall(1400, () => {
            this.updateMalongStatus("default");
          });
        }

        handleIncorrect() {
          // ì£¼ë¨¸ë‹ˆë¥¼ ì˜ëª» ê³ ë¥´ë©´ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.
          this.updateMalongStatus("sad"); // ë§ë¡±ì´ëŠ” ìŠ¬í¼í•©ë‹ˆë‹¤.
          this.consecutiveCorrect = 0;
          this.time.delayedCall(1400, () => {
            this.updateMalongStatus("default");
          });
        }

        updateBowlGraphic() {
          // ê·¸ë¦‡ì˜ ìƒíƒœë¥¼ ê°±ì‹ í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.
          // ğŸ’¡ ê³¼ì¼ ë‹¨ê³„(fruitStep) ê¸°ì¤€ìœ¼ë¡œ ì´ë¯¸ì§€ ë³€ê²½
          let bKey = `bowl${Math.min(this.fruitStep, 15)}`;
          if (this.textures.exists(bKey)) {
            this.bowl.setTexture(bKey);
          }
        }

        updateMalongStatus(state) {
          // ë§ë¡±ì´ì˜ ê¸°ë¶„ì„ ì¡°ì ˆí•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.
          if (this.isGameOver) return;
          if (state === "happy") this.malong.setTexture("malong_happy");
          else if (state === "sad") this.malong.setTexture("malong_sad");
          else this.malong.setTexture("malong_default");
        }

        endGame() {
          // ê²Œì„ì´ ëë‚¬ì„ ë•Œ, ê³¼ì¼ ê°¯ìˆ˜ë¥¼ ì¶œë ¥í•˜ê³  finishì™€ ì»´í¬ë„ŒíŠ¸ ì‚­ì œë¥¼ í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.
          this.isGameStarted = false;
          this.isGameOver = true; // ì´ ë³€ìˆ˜ê°€ ì¼œì§ìœ¼ë¡œì„œ finish ìƒíƒœë¥¼ ì˜ë¯¸í•˜ê²Œ ë©ë‹ˆë‹¤.
          this.isProcessingTurn = true; // ê²Œì„ ì¢…ë£Œ ì‹œ í´ë¦­ ì ê¸ˆ

          this.updateMalongStatus("default");
          this.timerBgGraphic.setVisible(false);
          this.timerBar.setVisible(false);
          this.quizBoard.setVisible(false);
          this.quizIcon.setVisible(false);
          this.questionProblem.setVisible(false);
          // ëª¨ë“  ì»´í¬ë„ŒíŠ¸ë“¤ì„ êº¼ë²„ë¦½ë‹ˆë‹¤.

          // ğŸ’¡ ì¢…ë£Œ ì‹œ ì•ˆì „í•˜ê²Œ ì‚­ì œ
          this.pockets.forEach((p) => {
            // ì£¼ë¨¸ë‹ˆë“¤ì„ ì•ˆì „í•˜ê²Œ ì‚­ì œí•©ë‹ˆë‹¤.
            if (p) {
              this.tweens.killTweensOf(p);
              if (p.label) p.label.destroy();
              p.destroy();
            }
          });
          this.pockets = [];

          const scoreText = this.add
            .text(this.bowl.x, 400, `ê³¼ì¼ ${this.score}ê°œ!`, {
              fontSize: "86px",
              fill: "#FFFF00",
              fontFamily: "Jua",
              fontStyle: "bold",
              stroke: "#000000",
              strokeThickness: 8,
            })
            .setOrigin(0.5);
          // ì ìˆ˜ë¥¼ ì¶œë ¥í•˜ëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤.

          this.time.delayedCall(
            // ì ìˆ˜ë¥¼ ì¶œë ¥í•œ ë’¤ 3ì´ˆ ë’¤ì—, finish ì°½ì„ ë„ì›ë‹ˆë‹¤.
            3000,
            () => {
              scoreText.setVisible(false);
              this.add
                .rectangle(
                  this.cameras.main.width / 2,
                  this.cameras.main.height / 2,
                  this.cameras.main.width,
                  this.cameras.main.height,
                  0x000000,
                  0.6
                ) // ì•½ê°„ ê²€ì€ ë°˜íˆ¬ëª… í™”ë©´ì„ ë„ìš°ëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤.
                .setDepth(100);
              this.add
                .text(
                  this.cameras.main.width / 2,
                  this.cameras.main.height / 2,
                  "FINISH!",
                  {
                    fontSize: "136px",
                    fill: "#FFFFFF",
                    fontFamily: "Jua",
                    fontStyle: "bold",
                  }
                )
                .setOrigin(0.5)
                .setDepth(101); // depthê°€ ë°˜íˆ¬ëª… í™”ë©´ë³´ë‹¤ í¬ë¯€ë¡œ í™”ë©´ ìœ„ì— ë‚˜ì˜µë‹ˆë‹¤.
            },
            [],
            this
          );
        }
      }

      const config = {
        type: Phaser.AUTO,
        backgroundColor: "#000000",
        scale: {
          mode: Phaser.Scale.FIT,
          autoCenter: Phaser.Scale.CENTER_BOTH,
          width: 1920,
          height: 1080,
        },
        scene: [GameScene],
      };
      const game = new Phaser.Game(config);
    </script>
  </body>
</html>
